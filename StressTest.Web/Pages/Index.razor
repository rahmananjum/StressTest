@page "/"
@inject IStressTestRunService RunService

<PageTitle>Stress Test</PageTitle>

<h2 class="mb-4">Stress Test – House Price Scenario</h2>

<div class="row">
    <div class="col-md-5">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary text-white">
                <strong>Country Price Changes (%)</strong>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    Enter the percentage change in house prices for each country.
                    Negative values represent a price decline.
                </p>

                @foreach (var country in _countries)
                {
                    <div class="mb-3 row align-items-center">
                        <label class="col-sm-3 col-form-label fw-semibold">@country</label>
                        <div class="col-sm-9">
                            <div class="input-group">
                                <input type="number"
                                       class="form-control"
                                       step="0.01"
                                       value="@_countryChanges[country]"
                                       @onchange="@((ChangeEventArgs e) => OnChangeUpdated(country, e.Value?.ToString()))" />
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                }

                <button class="btn btn-primary w-100 mt-2"
                        type="button"
                        @onclick="RunStressTest">
                    @if (_isRunning)
                    {
                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        <span>Running...</span>
                    }
                    else
                    {
                        <span>&#9654; Run Stress Test</span>
                    }
                </button>

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <div class="alert alert-danger mt-3">@_errorMessage</div>
                }
            </div>
        </div>
    </div>

    @if (_latestRun is not null)
    {
        <div class="col-md-7">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <strong>Results – Run #@_latestRun.Id</strong>
                    <small>@_latestRun.RunAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss") &nbsp;|&nbsp; @_latestRun.DurationMs ms</small>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Portfolio</th>
                                    <th>Country</th>
                                    <th>CCY</th>
                                    <th class="text-end">Loans</th>
                                    <th class="text-end">Outstanding</th>
                                    <th class="text-end">Collateral</th>
                                    <th class="text-end">Scenario Collateral</th>
                                    <th class="text-end">Expected Loss</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var r in _latestRun.Results.OrderBy(x => x.PortId))
                                {
                                    var elCss = r.TotalExpectedLoss > 0 ? "text-danger fw-bold" : "text-success";
                                    <tr>
                                        <td>@r.PortName</td>
                                        <td>@r.Country</td>
                                        <td>@r.Currency</td>
                                        <td class="text-end">@r.LoanCount</td>
                                        <td class="text-end">@r.TotalOutstandingAmount.ToString("N0")</td>
                                        <td class="text-end">@r.TotalCollateralValue.ToString("N0")</td>
                                        <td class="text-end">@r.TotalScenarioCollateralValue.ToString("N0")</td>
                                        <td class="text-end @elCss">@r.TotalExpectedLoss.ToString("N2")</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="table-secondary fw-bold">
                                <tr>
                                    <td colspan="4">Total</td>
                                    <td class="text-end">@_latestRun.Results.Sum(r => r.TotalOutstandingAmount).ToString("N0")</td>
                                    <td class="text-end">@_latestRun.Results.Sum(r => r.TotalCollateralValue).ToString("N0")</td>
                                    <td class="text-end">@_latestRun.Results.Sum(r => r.TotalScenarioCollateralValue).ToString("N0")</td>
                                    <td class="text-end text-danger">@_latestRun.Results.Sum(r => r.TotalExpectedLoss).ToString("N2")</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool _isRunning;
    private string? _errorMessage;
    private StressTestRun? _latestRun;

    private readonly string[] _countries = { "GB", "US", "FR", "DE", "SG", "GR" };

    private readonly Dictionary<string, decimal> _countryChanges = new()
    {
        ["GB"] = -5.12m,
        ["US"] = -4.34m,
        ["FR"] = -3.87m,
        ["DE"] = -1.23m,
        ["SG"] = -5.50m,
        ["GR"] = -5.68m
    };

    private void OnChangeUpdated(string country, string? valueStr)
    {
        if (decimal.TryParse(valueStr,
                System.Globalization.NumberStyles.Any,
                System.Globalization.CultureInfo.InvariantCulture,
                out var value))
        {
            _countryChanges[country] = value;
        }
    }

    private async Task RunStressTest()
    {
        if (_isRunning) return;
        _isRunning = true;
        _errorMessage = null;
        _latestRun = null;
        StateHasChanged();

        try
        {
            _latestRun = await RunService.RunAsync(_countryChanges);
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isRunning = false;
        }
    }
}
